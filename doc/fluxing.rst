*******
Fluxing
*******

Overview
========
The code matches a standard star to you science target based on
the time(s) of observation. If multiple standard stars are
supplied as calibration frames, PYPIT selects the standard star
observed closest in time to your science observation for fluxing.

Sensitivity Function
====================
PYPIT uses the CALSPEC calibration database, which can be found
at http://stsci.edu/hst/observatory/crds/calspec.html for flux
calibrations, specifically, generating the sensitivity function
(see also :doc:`standards`).

The sensitivity function is generated by dividing the standard
star's flux, which is loaded in by PYPIT from CALSPEC, by the
standard star's counts per second. This is then multiplied to the
science object's counts per second to yield a fluxed science
spectrum.

The sensitivity function is written to disk as a YAML file
in the MasterFrames folder with prefix MasterSensFunc.
There is only one file per setup (not per detector).  If one
has a previous file, this can be placed in the MasterFrames
folder to be loaded (one must turn on MasterFrame usage, e.g.
with the -m flag on run_pypit).

Fluxing Output
==============

Science
-------
The resulting fluxed science spectrum, :math:`\rm f_\lambda`,
is given in units of :math:`10^{-17}\,\rm ergs/s/cm^2/Angstrom`
and is stored in the 'box_flam' extension of the extracted 1D
spectrum. If an optimal extraction was successful, there also
exists an 'opt_flam' extension in the 1D spectrum.

Standard
--------
The 1D extracted standard spectrum is also saved as an output
of the fluxing routine. The counts and fluxed standard spectrum
are available in the 'box_counts' and 'box_flam' extensions,
respectively. The fluxed spectrum saved here is the fluxed standard,
using the sensitivity function generated from itself (rather than
the archived fluxed standard star loaded from CALSPEC), and can be
examined and compared to the expected :math:`\rm f_\lambda` as a
sanity check.

Troubleshooting
===============

Problem with bspline knot
-------------------------
Things sometimes go wrong the fluxing and it commonly has to do with 
the bspline algorithm. If you reach a stop in the code with a message
that says "Problem with bspline knot" there are a couple things to check:

    - There are instances where there isn't data 
      between the knots. You can change the knot spacing by including 
      the following in your .pypit file under the Reduce block::
        reduce skysub bspline everyn NUM
      where you adjust NUM. 
    - If your observation of the standard star is taken with a setup that 
      goes beyond the wavelength range of the version in data/standards/calspec.
    - If the wavelength solution is really bad it can manifest as problem in 
      bspline knot. If the issue isn't the spacing or wavelength coverage check
      the QA files to see if there is an issue in the wavelength solution. If 
      this is the case, check the :doc:`wave_calib` page for Troubleshooting 
      or open an issue on the GitHub repo.
